{% extends 'mainapp/basic.html' %}
{% load static %}


{% block title %}
{% load myfilters %}
StocksWatch - Tracker
{% endblock title %}


{% block css %}
  .red { color: red; }
  .green { color: green; }
  .darkgreen { color: darkgreen; }
  .brown { color: brown; }
{% endblock css %}


{% block body %}
<div class="container table-responsive">
<h3>Ativo(s) selecionado(s)</h3>
<table class="table-container">
<table class="table">

    <thead class="table-light">
      <tr>
        <th scope="col">ID</th>
        <th scope="col">Ativo</th>
        <th scope="col">Preço</th>
        <th scope="col">Fechamento</th>
        <th scope="col">Abertura</th>
        <th scope="col">Intradia</th>
        <th scope="col">52Wk Range</th>
        <th scope="col">Market Cap</th>
        <th scope="col">Volume</th>
        <th scope="col">Histórico</th>
      </tr>
    </thead>

    <!-- FILLING OUT THE TABLES WITH SELECTED STOCKS -->
    <tbody>
      {% for key, value in data.items %}
      <tr>
        <th scope="row">{{forloop.counter}}</th>
        <td id="{{key}}_ticker">{{key}}</td>
        <td id="{{key}}_price">{{ value|get:"Quote Price"|floatformat:2 }}</td>
        <td id="{{key}}_prevprice">{{ value|get:"Previous Close"|floatformat:2 }}</td>
        <td id="{{key}}_open">{{ value|get:"Open" }}</td>
        <!-- Intradia -->
        <td id="{{key}}_change">
          <script>
            var change = document.getElementById("{{key}}_price").innerHTML - document.getElementById("{{key}}_prevprice").innerHTML;
            change = Number((change).toFixed(4));
            if(change >= 0){
              document.getElementById("{{key}}_change").className = "green";
              document.getElementById("{{key}}_ticker").className = "darkgreen";
            }
            if (change < 0){
              document.getElementById("{{key}}_change").className = "red";
              document.getElementById("{{key}}_ticker").className = "brown";
            }
            document.getElementById("{{key}}_change").innerHTML = change;
          </script>
        </td>

        <td id="{{key}}_range">{{ value|get:"52 Week Range" }}</td>
        <td id="{{key}}_cap">{{ value|get:"Market Cap" }}</td>
        <td id="{{key}}_volume">{{ value|get:"Volume" }}</td>
        <!-- historico em graficos -->
        <td>    
          <form action='graph'>
              <button style="--bs-btn-padding-y: .15rem; --bs-btn-padding-x: .2rem; --bs-btn-font-size: .75rem;"
                      class="btn btn-primary btn-sm" 
                      name='graph' 
                      value={{key}} 
                      type="submit">Gráfico</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>

</table>
</table>
<a class="btn btn-primary btn-sm d-grid gap-2" 
        href="{% url 'create-alert' %}">Criar Alerta</a>
<br>
</div>

<!-- WEBSOCKET - JSON - LIVE STOCK -->
{{ room_name|json_script:"room-name" }}
<script>
  const roomName = JSON.parse(document.getElementById('room-name').textContent)
  var queryString = window.location.search;
  queryString = queryString.substring(1);
  console.log(queryString);
  const stockSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/stock/' + roomName + '/' + '?' + queryString
  );

  stockSocket.onmessage = function(e) {
    console.log(e.data);
    const data = JSON.parse(e.data);
    console.log(data);
    for (const [key, value] of Object.entries(data)){
      var price = Number((value['Quote Price']).toFixed(4));
      var prevprice = Number((value['Previous Close']).toFixed(4));
      document.getElementById(key + '_price').innerHTML = price;
      document.getElementById(key + '_prevprice').innerHTML = prevprice;
      document.getElementById(key + '_open').innerHTML = value['Open'];
      document.getElementById(key + '_range').innerHTML = value['52 Week Range'];
      document.getElementById(key + '_cap').innerHTML = value['Market Cap'];
      document.getElementById(key + '_volume').innerHTML = value['Volume'];
      var change = document.getElementById(key + '_price').innerHTML - document.getElementById(key + '_prevprice').innerHTML;
      change = Number((change).toFixed(4));
      if (change >= 0){
        document.getElementById(key + '_change').className = "green";
        document.getElementById(key + '_change').innerHTML = change;
      }
      else if (change < 0){
        document.getElementById(key + '_change').className = "red";
        document.getElementById(key + '_change').innerHTML = change;
      }
    }
  }
</script>
{% endblock body %}