{% extends 'mainapp/basic.html' %}
{% load static %}


{% block title %}
{% load myfilters %}
StocksWatch - Carteira
{% endblock title %}

{% block css %}
  .red { color: red; }
  .green { color: green; }
{% endblock css %}

{% block body %}
<div class="container">
    <br>
    <h3>Carteira</h3>

    <table class="table-container">
        <table class="table">

            <thead>  <!-- dados da tabela -->
                <tr>
                    <th scope="col">Nota</th>
                    <th scope="col">Ativo</th>
                    <th scope="col">Preço</th>
                    <th scope="col">P.M.</th>
                    <th scope="col">Qnt</th>
                    <th scope="col">Total</th>
                    <th scope="col">Quero%</th>
                    <th scope="col">Tenho%</th>
                    <th scope="col">Quero$</th>
                    <th scope="col">Falta$</th>
                    <th scope="col">Ordem</th>
                    <th scope="col">Vol</th>
                    <th scope="col">Close</th>
                    <th scope="col">Intradia</th>
                    <th scope="col">52Week</th>
                    <th scope="col">Remuneração</th>
                    <th scope="col">Ações</th>
                    <th scope="col">Histórico</th>
                </tr>
            </thead>

            <tbody>  <!-- preenchendo a tabela -->
                {% for key, value in data.items %}
                <tr>
                    <th id='{{key}}_nota'scope="row">{{key.nota}}</th>  <!-- Nota/peso -->
                    <td>{{key}}</td>  <!-- ativo/ticker -->
                    <td id='{{key}}_preco'>{{ value|get:'Quote Price'|floatformat:2 }}</td>  <!-- preco online -->
                    <td id='{{key}}_pm'>{{key.preco_medio}}</td>  <!-- preco medio -->
                    <td id='{{key}}_qnt'>{{key.quantidade}}</td>  <!-- qnt de papeis na carteira -->
                    <td id='{{key}}_total'>  <!-- Total do ativo na carteira = Quantidade * preco de mercado -->
                        <script>
                            result = document.getElementById('{{key}}_qnt').innerHTML *
                                        document.getElementById('{{key}}_preco').innerHTML;

                            document.getElementById('{{key}}_total').innerHTML = result.toFixed(2);
                        </script>
                    </td>
                    <td id='{{key}}_quero'></td>  <!--  QUERO % (nota/sum(notas)%)  -->
                    <td id='{{key}}_tenho'></td>  <!--  TENHO % (total/totais)  -->

                    <td id='{{key}}_quero_din'></td>  <!--  QUERO $ patrimonio * quero%  -->
                    <td id='{{key}}_falta_din'></td>  <!--  FALTA $ quero_din - total -->

                    <td id='{{key}}_ordem'></td>  <!--  ORDEM (comprar/vender)  -->
                    <td id='{{key}}_vol'></td>  <!--  VOLUME para comprar/vender = falta / preco-->

                    <td id='{{key}}_fechamento'>{{ value|get:'Previous Close'|floatformat:2 }}</td> <!-- fechamento -->

                    <td id="{{key}}_change"> <!-- intradia -->
                        <script>
                          var change = document.getElementById("{{key}}_preco").innerHTML - 
                                        document.getElementById("{{key}}_fechamento").innerHTML;

                          change = Number((change).toFixed(4));

                          if(change >= 0){document.getElementById("{{key}}_change").className = "green";}
                          if (change < 0){document.getElementById("{{key}}_change").className = "red";}

                          document.getElementById("{{key}}_change").innerHTML = change;
                        </script>
                    </td>

                    <td id='{{key}}_fiftytwo'>{{ value|get:'52 Week Range'}}</td>  <!-- 52 week range -->

                    <td id='{{key}}_rm'>  <!-- Remuneracao do ativo de acordo com preco medio -->
                        <script>
                            result = (document.getElementById('{{key}}_total').innerHTML /
                                        (document.getElementById('{{key}}_qnt').innerHTML *
                                            document.getElementById('{{key}}_pm').innerHTML)) - 1;

                            if (result >= 0){document.getElementById("{{key}}_rm").className = "green";}    
                            if (result < 0){document.getElementById("{{key}}_rm").className = "red";}

                            document.getElementById('{{key}}_rm').innerHTML = (result * 100).toFixed(2) + '%';
                        </script>
                    </td>

                    <td>  <!-- manipulacao de ativos da carteira - excluir/editar -->
                        <a class="btn btn-warning btn-sm"
                            style="--bs-btn-padding-y: .15rem; --bs-btn-padding-x: .2rem; --bs-btn-font-size: .75rem;"
                            href="{% url 'update-carteira' key.id %}">E</a>

                        <a class="btn btn-danger btn-sm"
                            style="--bs-btn-padding-y: .15rem; --bs-btn-padding-x: .2rem; --bs-btn-font-size: .75rem;"
                            href="{% url 'delete-carteira' key.id %}">X</a>
                    </td>

                    <td>    <!-- historico em graficos -->
                        <form action='graph'>
                            <button class="btn btn-primary btn-sm"
                                    style="--bs-btn-padding-y: .15rem; --bs-btn-padding-x: .2rem; --bs-btn-font-size: .75rem;"
                                    name='graph'
                                    value={{key}}
                                    type="submit">Gráfico</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
                <!-- soma todas as notas -->
                <script>
                    var notas = 0;
                    var totais = 0;
                    {% for key, value in data.items %}
                        var nota = document.getElementById('{{key}}_nota').innerHTML;
                        var total = document.getElementById('{{key}}_total').innerHTML;
                        notas += parseFloat(nota);
                        totais += parseFloat(total);
                    {% endfor %}

                    // QUERO E TENHO EM PORCENTAGEM: notas/notas, tenho/total
                    {% for key, value in data.items %}
                        // QUERO em %:
                        document.getElementById('{{key}}_quero').innerHTML = (
                            (parseFloat(document.getElementById('{{key}}_nota').innerHTML)/notas)*100).toFixed(2)+'%';
                        
                        // TENHO em %:
                        document.getElementById('{{key}}_tenho').innerHTML = (
                            (parseFloat(document.getElementById('{{key}}_total').innerHTML)/totais)*100).toFixed(2)+'%';

                        if (document.getElementById('{{key}}_quero').innerHTML < document.getElementById('{{key}}_tenho').innerHTML){
                            document.getElementById('{{key}}_tenho').className = "green";
                        }
                        if (document.getElementById('{{key}}_quero').innerHTML > document.getElementById('{{key}}_tenho').innerHTML){
                            document.getElementById('{{key}}_tenho').className = "red";
                        }
                    {% endfor %}

                    // ordem de compra e venda baseado em nota/qnt
                    {% for key, value in data.items %}
                    var quero = document.getElementById('{{key}}_quero').innerHTML;
                    var tenho = document.getElementById('{{key}}_tenho').innerHTML;
                    if ( parseFloat(quero) > parseFloat(tenho) ){
                        document.getElementById('{{key}}_ordem').className = "green";
                        document.getElementById('{{key}}_ordem').innerHTML = 'Comprar';
                    }
                    if ( parseFloat(quero) <= parseFloat(tenho) ){
                        document.getElementById('{{key}}_ordem').className = "red";
                        document.getElementById('{{key}}_ordem').innerHTML = 'Vender';
                    }
                    {% endfor %}
                </script>
            </tbody>
        </table>
    </table>
    <!-- adicionar novo ativo na carteira -->
    <a class="btn btn-primary btn-sm d-grid gap-2" href="{% url 'create-carteira' %}">Adicionar Novo Ativo</a>
    
    <!-- totais e balanço da carteira WIP -->
    <div style="float:right; padding: 15px;">
        <big>Patrimônio:</big>
        <big id='patrimonio'></big>
        <script>
            var patrimonio = 0;
            //patrimonio
            {% for key, value in data.items %}
                var valor_por_ativo = document.getElementById('{{key}}_total').innerHTML;
                patrimonio += parseFloat(valor_por_ativo);
            {% endfor %}
            document.getElementById('patrimonio').innerHTML = patrimonio.toFixed(2);

            // quero e falta em dinhero $$ + volume para balancear baseado em nota e patrimonio.
            {% for key, value in data.items %}
                //QUERO EM DINHEIRO: precisa do valor patrimonio para calcular
                document.getElementById('{{key}}_quero_din').innerHTML = (
                            patrimonio * (parseFloat(document.getElementById('{{key}}_quero').innerHTML)/100)).toFixed(2);
                //FALTA EM DINHEIRO: precisa do valor quero_din para calcular
                document.getElementById('{{key}}_falta_din').innerHTML = (
                            document.getElementById('{{key}}_quero_din').innerHTML -
                                document.getElementById('{{key}}_total').innerHTML).toFixed(2);
                //VOLUME DE COMPRA: precisa do valor falta_din para calcular
                document.getElementById('{{key}}_vol').innerHTML = parseInt(
                            parseFloat(document.getElementById('{{key}}_falta_din').innerHTML) /
                            parseFloat(document.getElementById('{{key}}_preco').innerHTML));
            {% endfor %}
        </script>
    </div>

</div>

{% endblock body %}